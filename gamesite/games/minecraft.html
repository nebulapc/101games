<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minecraft Portal</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f0f14;
    color: white;
    text-align: center;
  }
  #setupBox {
    margin-top: 120px;
  }
  input {
    padding: 10px;
    font-size: 18px;
  }
  button {
    padding: 10px 20px;
    font-size: 18px;
    margin: 5px;
    cursor: pointer;
  }
  iframe {
    width: 100vw;
    height: 100vh;
    border: none;
    display: none;
  }
  #msg {
    margin-top: 15px;
    color: #ff8080;
  }
</style>
</head>
<body>

<div id="setupBox">
  <h1>Welcome</h1>
  <p>Enter or confirm your Minecraft username</p>
  <input id="usernameInput" placeholder="Minecraft Username">
  <br><br>
  <button id="saveBtn">Update Username</button>
  <button id="continueBtn">Continue</button>
  <p id="msg"></p>
</div>

<iframe id="gameFrame" src="https://4jwhspmk-8081.use2.devtunnels.ms/"></iframe>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, goOffline } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ðŸ”¹ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDmcFEoCa9W1mDXDHE8WUo4tOycLSoxneE",
  authDomain: "nebulakc-e0459.firebaseapp.com",
  databaseURL: "https://nebulakc-e0459-default-rtdb.firebaseio.com",
  projectId: "nebulakc-e0459",
  storageBucket: "nebulakc-e0459.firebasestorage.app",
  messagingSenderId: "661377108410",
  appId: "1:661377108410:web:34acdbb2874470750ff583",
  measurementId: "G-3MC79LHPFD"
};

// ðŸ”¹ Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ðŸ”¹ Use UUID as key
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}

const playerRef = ref(db, "players/" + userId);

const setupBox = document.getElementById("setupBox");
const iframe = document.getElementById("gameFrame");
const msg = document.getElementById("msg");
const input = document.getElementById("usernameInput");
const saveBtn = document.getElementById("saveBtn");
const continueBtn = document.getElementById("continueBtn");

let playerData = null;

// ðŸ”¹ Load player data
get(playerRef).then(snapshot => {
  if (!snapshot.exists() || snapshot.val() === null) {
    msg.textContent = "You are not in the database yet. Please register your username.";
    return;
  }

  playerData = snapshot.val();

  if (playerData.banned) {
    document.body.innerHTML = `
      <h1 style="margin-top:20%;color:red;">ðŸš« You are banned</h1>
      <p>You cannot access this site.</p>
    `;
    return;
  }

  if (playerData.username) {
    input.value = playerData.username;
  }
});

// ðŸ”¹ Save / Update username
saveBtn.onclick = async () => {
  const username = input.value.trim();
  if (!username) {
    msg.textContent = "Enter a username.";
    return;
  }

  try {
    await update(playerRef, {
      username: username,
      lastUpdated: new Date().toISOString(),
      active: true,
      banned: false
    });
    msg.style.color = "#80ff80";
    msg.textContent = "Username updated!";
  } catch (err) {
    msg.style.color = "#ff8080";
    msg.textContent = "Error saving username.";
    console.error(err);
  }
};

// ðŸ”¹ Continue button
continueBtn.onclick = async () => {
  const username = input.value.trim();
  if (!username) {
    msg.textContent = "You must enter a username.";
    return;
  }

  try {
    const snap = await get(playerRef);
    if (!snap.exists() || snap.val() === null) {
      msg.textContent = "You are not in the database.";
      return;
    }

    const data = snap.val();
    if (data.banned) {
      document.body.innerHTML = `
        <h1 style="margin-top:20%;color:red;">ðŸš« You are banned</h1>
        <p>You cannot access this site.</p>
      `;
      return;
    }

    if (data.username !== username) {
      msg.textContent = "Username does not match our records!";
      return;
    }

    // Update lastSeen and disconnect Firebase
    await update(playerRef, { lastSeen: new Date().toISOString() });
    goOffline(db);

    // Launch game
    setupBox.style.display = "none";
    iframe.style.display = "block";

  } catch (err) {
    console.error(err);
    msg.textContent = "Error checking your account.";
  }
};
</script>

</body>
</html>
